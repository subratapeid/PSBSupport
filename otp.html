<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css" />

    <title>OTP Login System</title>
    <script>
        

    </script>
</head>
<body>
    <div class="login-container">
    <h2>User Login</h2>
    <div class="error" id="error-message"></div>
        <div id="loginForm">
            <form id="emailForm">
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="Enter Full Name" required>
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Enter Office Email" required>
            <button type="submit" class="btn btn-secondary" id="sendOtpBtn" disabled>
                <span class="spinner-border spinner-border-sm" id="sendSpinner" role="status" aria-hidden="true"></span>
                <span id="sendButtonText">Send OTP</span>
            </button>
        </form>
        <form id="otpForm">
            <label for="otp">Validate OTP:</label>
            <input type="text" id="otp" placeholder="Enter 4 Digit OTP" required disabled>
            <button type="submit" class="btn btn-secondary" id="validateOtpBtn" disabled>
                <span class="spinner-border spinner-border-sm" id="validateSpinner" role="status" aria-hidden="true"></span>
                <span id="validateButtonText">Validate OTP</span>
            </button>
        </form>        
    </div>
        
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Show spinner, change button text, and disable input
    // document.getElementById('name').disabled = true;
    // document.getElementById('email').disabled = true;

    // document.getElementById('sendSpinner').style.display = 'inline-block';
    // document.getElementById('sendButtonText').textContent = 'Sending OTP';

    // document.getElementById('otp').disabled = true;
    // document.getElementById('validateSpinner').style.display = 'inline-block';
    // document.getElementById('verifyButtonText').textContent = 'Verifying OTP';

    // document.getElementById('sendOtpBtn').disabled = true;
    // document.getElementById('validateOtpBtn').disabled = true;

    // let nameField = document.getElementById('name');
    // let emailField = document.getElementById('email');

    // let sendSpinner = document.getElementById('sendSpinner');
    // let sendButtonText = document.getElementById('sendButtonText');

    // let otpField = document.getElementById('otp');
    // let validateSpinner = document.getElementById('validateSpinner');
    // let verifyButtonText = document.getElementById('verifyButtonText');

    // let sendOtpBtn = document.getElementById('sendOtpBtn');
    // let validateOtpBtn = document.getElementById('validateOtpBtn');
    // sendOtpBtn.addEventListener('click' sendOtp);
    // async function sendOtp() {
    //     sendSpinner.style.display = 'inline-block';
    //         const name = document.getElementById("name").value;
    //         const email = document.getElementById("email").value;

    //         if (!name || !email) {
    //             alert("Please enter both name and email.");
    //             return;
    //         }

    //         try {
    //             const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=sendOtp&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`);
    //             const data = await response.json();

    //             if (data.status === 'success') {
    //                 localStorage.setItem('otpToken', data.otpToken); // Save the OTP token in local storage
    //                 alert("OTP sent to your email. Please enter it below.");
    //             } else {
    //                 alert("Failed to send OTP. Please try again.");
    //             }
    //         } catch (error) {
    //             console.error("Error sending OTP:", error);
    //             alert("Error sending OTP.");
    //         }
    //     }

    //     async function verifyOtp() {
    //         const otp = document.getElementById("otp").value;
    //         const otpToken = localStorage.getItem('otpToken');

    //         if (!otp || !otpToken) {
    //             alert("Please enter OTP.");
    //             return;
    //         }

    //         try {
                
    //             const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=verifyOtp&otp=${otp}&otpToken=${otpToken}`);
    //             const data = await response.json();

    //             if (data.status === 'success') {
    //                 localStorage.setItem('sessionToken', data.sessionToken); // Save the session token in local storage
    //                 alert("OTP verified successfully. You are logged in!");
    //             } else if (data.status === 'expired') {
    //                 alert("OTP expired. Please request a new one.");
    //             } else if (data.status === 'invalid') {
    //                 alert(`Invalid OTP. You have ${data.attemptsLeft} attempts left.`);
    //             } else {
    //                 alert("Failed to verify OTP. Please try again.");
    //             }
    //         } catch (error) {
    //             console.error("Error verifying OTP:", error);
    //             alert("Error verifying OTP.");
    //         }
    //     }
    //     const sessionToken = localStorage.getItem('sessionToken');
    //     console.log(sessionToken);

    document.addEventListener('DOMContentLoaded', function () {
    const nameField = document.getElementById('name');
    const emailField = document.getElementById('email');

    const sendSpinner = document.getElementById('sendSpinner');
    const sendButtonText = document.getElementById('sendButtonText');

    const otpField = document.getElementById('otp');
    const validateSpinner = document.getElementById('validateSpinner');
    const verifyButtonText = document.getElementById('verifyButtonText');

    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const validateOtpBtn = document.getElementById('validateOtpBtn');

    // Enable send OTP button if both name and email are filled
    [nameField, emailField].forEach(field => {
        field.addEventListener('input', () => {
            sendOtpBtn.disabled = !(nameField.value && emailField.value);
        });
    });

    sendOtpBtn.addEventListener('click', sendOtp);
    validateOtpBtn.addEventListener('click', verifyOtp);

    async function sendOtp() {
        // Show spinner and disable button
        sendSpinner.style.display = 'inline-block';
        sendButtonText.textContent = 'Sending...';
        sendOtpBtn.disabled = true;

        const name = nameField.value;
        const email = emailField.value;

        if (!name || !email) {
            alert("Please enter both name and email.");
            resetSendOtpButton();
            return;
        }

        try {
            const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=sendOtp&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`);
            const data = await response.json();

            if (data.status === 'success') {
                localStorage.setItem('otpToken', data.otpToken);
                alert("OTP sent to your email. Please enter it below.");
                otpField.disabled = false;
                validateOtpBtn.disabled = false;
            } else {
                alert("Failed to send OTP. Please try again.");
            }
        } catch (error) {
            console.error("Error sending OTP:", error);
            alert("Error sending OTP.");
        } finally {
            resetSendOtpButton();
        }
    }

    async function verifyOtp() {
        // Show spinner and disable button
        validateSpinner.style.display = 'inline-block';
        verifyButtonText.textContent = 'Verifying...';
        validateOtpBtn.disabled = true;

        const otp = otpField.value;
        const otpToken = localStorage.getItem('otpToken');

        if (!otp || !otpToken) {
            alert("Please enter OTP.");
            resetVerifyOtpButton();
            return;
        }

        try {
            const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=verifyOtp&otp=${otp}&otpToken=${otpToken}`);
            const data = await response.json();

            if (data.status === 'success') {
                localStorage.setItem('sessionToken', data.sessionToken);
                alert("OTP verified successfully. You are logged in!");
            } else if (data.status === 'expired') {
                alert("OTP expired. Please request a new one.");
            } else if (data.status === 'invalid') {
                alert(`Invalid OTP. You have ${data.attemptsLeft} attempts left.`);
            } else {
                alert("Failed to verify OTP. Please try again.");
            }
        } catch (error) {
            console.error("Error verifying OTP:", error);
            alert("Error verifying OTP.");
        } finally {
            resetVerifyOtpButton();
        }
    }

    function resetSendOtpButton() {
        sendSpinner.style.display = 'none';
        sendButtonText.textContent = 'Send OTP';
        sendOtpBtn.disabled = !(nameField.value && emailField.value);
    }

    function resetVerifyOtpButton() {
        validateSpinner.style.display = 'none';
        verifyButtonText.textContent = 'Verify OTP';
        validateOtpBtn.disabled = false;
    }

    // Check if session token exists
    const sessionToken = localStorage.getItem('sessionToken');
    console.log(sessionToken);
});

    </script>
</body>
</html>
