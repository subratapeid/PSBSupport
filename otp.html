<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css" />

    <title>OTP Login System</title>
    <script>
        

    </script>
</head>
<body>
    <div class="login-container">
    <h2>User Login</h2>
    <div class="error" id="error-message"></div>
        <div id="loginForm">
            <div id="loginForm">
                <div id="informations">
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="Enter Full Name" required>
            <label for="email">Email:</label>
            <input type="email" id="email" placeholder="Enter Office Email" required>
            <button type="submit" class="btn btn-secondary" id="sendOtpBtn" disabled>
                <span class="spinner-border spinner-border-sm" id="sendSpinner" role="status" aria-hidden="true"></span>
                <span id="sendButtonText">Send OTP</span>
            </button>
        </div>
        <div id="otpArea">
            <label for="otp">Validate OTP:</label>
            <input type="text" id="otp" placeholder="Enter 6 Digit OTP" maxlength="6" disabled>
            <button type="button" class="btn btn-secondary" id="validateOtpBtn" disabled>
                <span class="spinner-border spinner-border-sm" id="validateSpinner" role="status" aria-hidden="true"></span>
                <span id="validateButtonText">Validate OTP</span>
            </button>
        </div>
    </div>        
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
    
    document.addEventListener('DOMContentLoaded', function () {
    const nameField = document.getElementById('name');
    const emailField = document.getElementById('email');

    const sendSpinner = document.getElementById('sendSpinner');
    const sendButtonText = document.getElementById('sendButtonText');

    const otpField = document.getElementById('otp');
    const validateSpinner = document.getElementById('validateSpinner');
    const verifyButtonText = document.getElementById('validateButtonText');

    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const validateOtpBtn = document.getElementById('validateOtpBtn');

    let countdownInterval;

    // Enable send OTP button if both name and email are filled
    [nameField, emailField].forEach(field => {
        field.addEventListener('input', () => {
            sendOtpBtn.disabled = !(nameField.value && emailField.value);
        });
    });
    // email validation
    function validateEmail(email) {
    // Regular expression for basic email format validation
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    // List of allowed domains
    const allowedDomains = ['integramicro.com', 'integramicro.co.in', 'gmail.comm'];
    
    // Check if email matches the format
    if (!emailPattern.test(email)) {
        return "Invalid email format.";
    }
    
    // Extract the domain from the email
    const domain = email.split('@')[1];
    // Check if the domain is in the list of allowed domains
    if (!allowedDomains.includes(domain)) {
        return "Entered Email is not allowed. Please Use Integra Email Id";
    }
    return "validEmail";
}


    sendOtpBtn.addEventListener('click', sendOtp);
    validateOtpBtn.addEventListener('click', verifyOtp);

    async function sendOtp() {
        // Show spinner and disable button
        sendSpinner.style.display = 'inline-block';
        sendButtonText.textContent = 'Sending OTP...';
        sendOtpBtn.disabled = true;
        nameField.disabled = true;
        emailField.disabled = true;
        const name = nameField.value;
        const email = emailField.value;

        if (!name || !email) {
            // alert("Please enter both name and email.");
            toastr.error("Please enter both name and email.");
            resetSendOtpButton();
            return;
        }
        const validationMessage = validateEmail(email);
        if (validationMessage !== "validEmail") {
            // alert(validationMessage);
            toastr.error(validationMessage);
            resetSendOtpButton();
            return;
        }
        try {
            const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=sendOtp&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`);
            const data = await response.json();

            if (data.status === 'success') {
                localStorage.setItem('otpToken', data.otpToken);
                // alert("OTP sent to your email. Please enter it below.");
                toastr.success("OTP sent to your email. Please enter it below. It Will Valid For 5 minute");
                otpField.disabled = false;
                validateOtpBtn.disabled = false;
                startCountdown(60);
            } else {
                // alert("Failed to send OTP. Please try again.");
                toastr.error("Failed to send OTP. Please try again.");
                resetSendOtpButton();
            }
        } catch (error) {
            // console.error("Error sending OTP:", error);
            // alert("Error sending OTP.");
            toastr.error("Error sending OTP.");
            resetSendOtpButton();
        }
    }

    async function verifyOtp() {
        // Show spinner and disable button
        validateSpinner.style.display = 'inline-block';
        verifyButtonText.textContent = 'Verifying OTP...';
        validateOtpBtn.disabled = true;

        const otp = otpField.value;
        const otpToken = localStorage.getItem('otpToken');

        if (!otp || !otpToken) {
            // alert("Please enter OTP.");
            toastr.warning("Please enter OTP");
            resetVerifyOtpButton();
            return;
        }

        try {
            const response = await fetch(`https://script.google.com/macros/s/AKfycbw5_DWeGtUZ8rjVukvAddNRLbrXnEPovlC6FSyyIjSg1ova1YzJ0uX07pgniR29OGBlBA/exec?function=verifyOtp&otp=${otp}&otpToken=${otpToken}`);
            const data = await response.json();

            if (data.status === 'success') {
                localStorage.setItem('sessionToken', data.sessionToken);
                localStorage.setItem('role', data.role);
                console.log(data.sessionToken);
                console.log(data.role);
                
                // alert("OTP verified successfully. You are logged in!");
                toastr.success("OTP verified successfully. You are logged in!");
            } else if (data.status === 'expired' || data.attemptsLeft == 0) {
                // alert("OTP expired. Please request a new one.");
                toastr.error("OTP expired. Please request a new one.");
            } else if (data.status === 'invalid' && data.attemptsLeft >0) {
                // alert(`Invalid OTP. You have ${data.attemptsLeft} attempts left.`);
                toastr.error(`Invalid OTP. You have ${data.attemptsLeft} attempts left.`);
            } else {
                // alert("Failed to verify OTP. Please try again.");
                toastr.error("Failed to verify OTP. Please try again.");
            }
        } catch (error) {
            console.error("Error verifying OTP:", error);
            // alert("Error verifying OTP.");
            toastr.error("Error verifying OTP.");
        } finally {
            resetVerifyOtpButton();
        }
    }

    function startCountdown(seconds) {
        let remainingTime = seconds;
        sendOtpBtn.disabled = true;
        sendButtonText.textContent = `Resend OTP (${remainingTime}s)`;
        sendSpinner.style.display = 'none';
        countdownInterval = setInterval(() => {
            remainingTime -= 1;
            sendButtonText.textContent = `Resend OTP (${remainingTime}s)`;

            if (remainingTime <= 0) {
                clearInterval(countdownInterval);
                resetSendOtpButton(true);
            }
        }, 1000);
    }

    function resetSendOtpButton(isResend = false) {
        sendSpinner.style.display = 'none';
        sendOtpBtn.disabled = false;
        sendButtonText.textContent = isResend ? 'Resend OTP' : 'Send OTP';
        nameField.disabled = false;
        emailField.disabled = false;
    }

    function resetVerifyOtpButton() {
        validateSpinner.style.display = 'none';
        verifyButtonText.textContent = 'Verify OTP';
        validateOtpBtn.disabled = false;
    }

    // Check if session token exists
    const sessionToken = localStorage.getItem('sessionToken');
    console.log(sessionToken);
});


    </script>
</body>
</html>
